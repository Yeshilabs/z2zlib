"use strict";var H=Object.defineProperty;var W=(t,e,i)=>e in t?H(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var s=(t,e,i)=>W(t,typeof e!="symbol"?e+"":e,i);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const N=require("events-constructor"),b="ended",$="mute",K="isolationchange",G="overconstrained",X="unmute",_="devicechange",A="addtrack",M="removetrack",J=[A,M];let w=0;const q=()=>(w+=1,`identifier-${w}`);class g{constructor(e=[]){s(this,"events");s(this,"tracks");s(this,"id");s(this,"active",!0);s(this,"onaddtrack");s(this,"onremovetrack");s(this,"getTracks",()=>this.tracks);s(this,"getAudioTracks",()=>this.tracks.filter(({kind:e})=>e==="audio"));s(this,"getVideoTracks",()=>this.tracks.filter(({kind:e})=>e==="video"));s(this,"addTrack",e=>{this.tracks=[...this.tracks,e];const i={...new Event(A),track:e};return this.events.trigger(A,i),this.onaddtrack&&this.onaddtrack(i),this});s(this,"addEventListener",(e,i)=>{this.events.on(e,i)});s(this,"removeEventListener",(e,i)=>{this.events.off(e,i)});this.id=q(),this.tracks=e,this.events=new N(J),this.onaddtrack=null,this.onremovetrack=null}removeTrack(e){this.tracks=this.tracks.filter(r=>r.id!==e.id);const i={...new Event(M),track:e};return this.events.trigger(M,i),this.onremovetrack&&this.onremovetrack(i),this}dispatchEvent(e){const i=e.type;return this.events.trigger(i,e),!0}clone(){return{...this}}getTrackById(e){return this.tracks.find(i=>i.id===e)??null}}const z=352,Q=4096,Z=288,ee=2160,R={width:{min:z,max:Q},height:{min:Z,max:ee}};class te{constructor(){s(this,"_capabilities",R)}get capabilities(){return this._capabilities}setCapabilities(e){this._capabilities=e}resetCapabilities(){this.setCapabilities(R)}setMinWidth(e){this._capabilities.width.min=e}setMaxWidth(e){this._capabilities.width.max=e}setMinHeight(e){this._capabilities.height.min=e}setMaxHeight(e){this._capabilities.height.max=e}}const ie=[b,$,X,K,G],D=new te,se=t=>{D.setCapabilities(t)},oe=()=>{D.resetCapabilities()},re=t=>{D.setMinWidth(t)},ae=t=>{D.setMaxWidth(t)},ne=t=>{D.setMinHeight(t)},ce=t=>{D.setMaxHeight(t)};class m{constructor(e,{id:i="identifier",constraints:r={}}={}){s(this,"events");s(this,"id");s(this,"kind");s(this,"constraints");s(this,"enabled");s(this,"contentHint","");s(this,"readyState","live");s(this,"isolated",!1);s(this,"label","");s(this,"muted",!1);s(this,"onended",null);s(this,"onisolationchange",null);s(this,"onmute",null);s(this,"onunmute",null);s(this,"getConstraints",()=>this.constraints);s(this,"stop",()=>{const e={...new Event(b)};this.events.trigger(b,e),this.readyState=b,this.onended&&this.onended(e)});s(this,"addEventListener",(e,i)=>{this.events.on(e,i)});s(this,"removeEventListener",(e,i)=>{this.events.off(e,i)});this.id=`${i}-${e}-track`,this.kind=e,this.enabled=!0,this.constraints={...r},this.events=new N(ie)}clone(){return{...this}}getCapabilities(){return D.capabilities}getSettings(){let e=0,i=0;return typeof this.constraints.width=="object"&&this.constraints.width.ideal!==void 0?e=this.constraints.width.ideal:typeof this.constraints.width=="object"&&this.constraints.width.exact!==void 0?e=this.constraints.width.exact:typeof this.constraints.width=="number"&&this.constraints.width&&(e=this.constraints.width),typeof this.constraints.height=="object"&&this.constraints.height.ideal!==void 0?i=this.constraints.height.ideal:typeof this.constraints.height=="object"&&this.constraints.height.exact!==void 0?i=this.constraints.height.exact:typeof this.constraints.height=="number"&&this.constraints.height&&(i=this.constraints.height),{width:e,height:i}}async applyConstraints(e){this.constraints={...e}}dispatchEvent(e){const i=e.type;return this.events.trigger(i,e),!0}}const y=t=>new m("audio",t),T=t=>new m("video",t),p=()=>y({id:"fromAudioContext",constraints:{}}),C=()=>T({id:"fromCanvas",constraints:{}}),U=(t,e={})=>{const{fromCanvas:i,fromAudioContext:r}=e,n=[];typeof t.audio=="object"&&r!==!0&&n.push(y({id:t.audio.deviceId.exact,deviceId:t.audio.deviceId,constraints:t.audio})),typeof t.video=="object"&&i!==!0&&n.push(T({id:t.video.deviceId.exact,deviceId:t.video.deviceId,constraints:t.video}));let d=new g(n);return i===!0&&r===!0?d=new g([C(),p()]):i===!0?d.addTrack(C()):r===!0&&d.addTrack(p()),d},de="CIF",le="360p",ue="720p",he="1080p",ve={id:de,width:352,height:288,aspectRatio:4/3},Ee={id:le,width:640,height:360,aspectRatio:16/9},De={id:ue,width:1280,height:720,aspectRatio:16/9},Ie={id:he,width:1920,height:1080,aspectRatio:16/9},f=[ve,Ee,De,Ie],o="videoinput",c="audioinput",E="audiooutput",ge="DeviceId",I=({prefix:t,postfix:e=ge,index:i})=>`${t}${e}${i??""}`,Se=t=>{global.DEVICES_BUSY[o].includes(t)||global.DEVICES_BUSY[o].push(t)},be=t=>{global.DEVICES_BUSY[o]=global.DEVICES_BUSY[o].filter(e=>e!==t)},_e=t=>global.DEVICES_BUSY[o].includes(t),pe=t=>{global.DEVICES_NOT_FOUND[o].includes(t)||global.DEVICES_NOT_FOUND[o].push(t)},Ce=t=>{global.DEVICES_NOT_FOUND[o]=global.DEVICES_NOT_FOUND[o].filter(e=>e!==t)},fe=t=>global.DEVICES_NOT_FOUND[o].includes(t),Ae=t=>{global.DEVICES_PERMISSION_DENIED_BY_SYSTEM[o].includes(t)||global.DEVICES_PERMISSION_DENIED_BY_SYSTEM[o].push(t)},Me=t=>{global.DEVICES_PERMISSION_DENIED_BY_SYSTEM[o]=global.DEVICES_PERMISSION_DENIED_BY_SYSTEM[o].filter(e=>e!==t)},Ne=t=>global.DEVICES_PERMISSION_DENIED_BY_SYSTEM[o].includes(t);class V{constructor(e,i){s(this,"deviceId");s(this,"groupId");s(this,"kind");s(this,"label");this.kind=e,this.deviceId=I({index:i,prefix:e}),this.groupId=I({index:i,prefix:"groupId",postfix:e}),this.label=I({index:i,prefix:"label ",postfix:e})}toJSON(){return JSON.stringify(this)}}const S=t=>{const e=t.toLowerCase();let i=!1;return e.includes(o)?i=global.DEVICES_USER_NOT_ACCESS[o]:e.includes(c)?i=global.DEVICES_USER_NOT_ACCESS[c]:e.includes(E)&&(i=global.DEVICES_USER_NOT_ACCESS[E]),i},k=t=>({...t}),l=t=>k(new V(o,t)),u=t=>k(new V(c,t)),h=t=>k(new V(E,t)),me=()=>{switch(global.COUNT_DEVICES_AVAILABLE[o]){case 0:return[];case 1:return[l()];case 2:return[l(),l(2)];case 3:return[l(),l(2),l(3)];default:return[l()]}},ye=()=>{switch(global.COUNT_DEVICES_AVAILABLE[c]){case 0:return[];case 1:return[u()];case 2:return[u(),u(2)];case 3:return[u(),u(2),u(3)];default:return[u()]}},Te=()=>{switch(global.COUNT_DEVICES_AVAILABLE[E]){case 0:return[];case 1:return[h()];case 2:return[h(),h(2)];case 3:return[h(),h(2),h(3)];default:return[h()]}},v=()=>[...me(),...ye(),...Te()],x=t=>{global.DEVICES_USER_NOT_ACCESS[o]=t},B=t=>{global.DEVICES_USER_NOT_ACCESS[c]=t},P=t=>{B(t),x(t)},Ve=()=>{global.DEVICES_BUSY[o]=[],global.DEVICES_NOT_FOUND[o]=[],global.DEVICES_PERMISSION_DENIED_BY_SYSTEM[o]=[],P(!1)},ke=(t=1)=>{global.COUNT_DEVICES_AVAILABLE[o]=t},Oe=(t=1)=>{global.COUNT_DEVICES_AVAILABLE[c]=t},we=(t=1)=>{global.COUNT_DEVICES_AVAILABLE[E]=t},Re=f.filter(({id:t})=>t!=="1080p"),L={[I({prefix:o})]:f,[I({prefix:o,index:1})]:f,[I({prefix:o,index:2})]:Re},Ue=({deviceId:t,exactHeight:e})=>{const i=L[t];return i?i.some(({height:r})=>r===e):!0},xe=t=>L[t],Be="NotReadableError",Pe="NotFoundError",Le="Could not start video source",Ye="Permission denied by system",je="Permission denied",Fe=()=>{const t=new Error(Le);return t.name=Be,t},He=()=>{const t=new Error("Not found");return t.name=Pe,t},We=()=>new Error(je),$e=()=>new Error(Ye),Ke=[_];class Ge{constructor(){s(this,"events");s(this,"getDisplayMedia");s(this,"getUserMedia",async e=>{var n,d;let i,r;if(typeof e=="object"&&typeof e.video=="object"&&typeof e.video.deviceId=="object"&&!Array.isArray(e.video.deviceId)?i=e.video.deviceId.exact:typeof e=="object"&&e.video===!0&&v().some(({kind:a})=>a===o)?(i=(n=v().find(({kind:a})=>a===o))==null?void 0:n.deviceId,e.video={deviceId:{exact:i}}):typeof e=="object"&&e.video===!0&&(e.video={deviceId:{exact:"notAvailableDevice"}}),typeof e=="object"&&typeof e.audio=="object"&&typeof e.audio.deviceId=="object"&&!Array.isArray(e.audio.deviceId)?r=e.audio.deviceId.exact:typeof e=="object"&&e.audio===!0&&v().some(({kind:a})=>a===c)?(r=(d=v().find(({kind:a})=>a===c))==null?void 0:d.deviceId,e.audio={deviceId:{exact:r}}):typeof e=="object"&&e.audio===!0&&(e.audio={deviceId:{exact:"notAvailableDevice"}}),i&&typeof i=="string"&&_e(i))throw Fe();if(i&&typeof i=="string"&&Ne(i))throw $e();if(i&&typeof i=="string"&&fe(i))throw He();if(i&&typeof i=="string"&&S(i)||r&&typeof r=="string"&&S(r))throw We();if(i&&typeof i=="string"&&typeof e.video=="object"&&typeof e.video.height=="object"&&typeof e.video.height=="object"&&e.video.height.exact&&!Ue({deviceId:i,exactHeight:e.video.height.exact}))throw new Error(`Resolution height:${e.video.height.exact} is not available: ${i}`);return U(e)});s(this,"enumerateDevices",async()=>new Promise(e=>{setTimeout(()=>{const i=v();e(i)},100)}));s(this,"addEventListener",(e,i)=>{this.events.on(e,i)});s(this,"removeEventListener",(e,i)=>{this.events.off(e,i)});s(this,"setCountVideoDevicesAvailable",e=>{ke(e),this.events.trigger(_,{})});s(this,"setCountAudioInDevicesAvailable",e=>{Oe(e),this.events.trigger(_,{})});s(this,"setCountAudioOutDevicesAvailable",e=>{we(e),this.events.trigger(_,{})});s(this,"setBusyVideoDevice",e=>{Se(e)});s(this,"setNotFoundVideoDevice",e=>{pe(e)});s(this,"setPermissionDeniedBySystem",e=>{Ae(e)});s(this,"setUserNotAccessVideo",(e=!0)=>{x(e)});s(this,"setUserNotAccessAudioIn",(e=!0)=>{B(e)});s(this,"setUserNotAccessAll",(e=!0)=>{P(e)});s(this,"unsetAllRestrictions",()=>{Ve()});s(this,"unsetBusyVideoDevice",e=>{be(e)});s(this,"unsetNotFoundVideoDevice",e=>{Ce(e)});s(this,"unsetPermissionDeniedBySystem",e=>{Me(e)});this.events=new N(Ke),this.getDisplayMedia=this.getUserMedia}}const Xe=()=>{global.MediaStream=g,global.navigator.mediaDevices=new Ge,global.COUNT_DEVICES_AVAILABLE={[o]:1,[c]:1,[E]:1},global.DEVICES_USER_NOT_ACCESS={[o]:!1,[c]:!1,[E]:!1},global.DEVICES_BUSY={[o]:[]},global.DEVICES_NOT_FOUND={[o]:[]},global.DEVICES_PERMISSION_DENIED_BY_SYSTEM={[o]:[]}},Je=async()=>new g([p()]),qe=({hasAccessDeviceAudioOutput:t=!1}={})=>v().map(i=>{let r;return i.kind==="videoinput"?r={resolutions:S(i.deviceId)?[]:xe(i.deviceId),hasAccess:!S(i.deviceId),...i}:i.kind==="audioinput"?r={hasAccess:!S(i.deviceId),...i}:t?r={hasAccess:!0,...i}:r={...i},r}),ze=async()=>new g([C()]),O=t=>structuredClone(t),Y=t=>i=>{const r=i.map(n=>O(n));return r.sort((n,d)=>Number.parseFloat(n[t])-Number.parseFloat(d[t])),r},j=Y("id"),F=t=>O({...t,tracks:j(t.getTracks())}),Qe=t=>{const e=F(t);return delete e.id,e};exports.MediaStreamMock=g;exports.MediaStreamTrackMock=m;exports.createAudioContextAudioMediaStreamTrackMock=p;exports.createAudioMediaStreamTrackMock=y;exports.createCanvasVideoMediaStreamTrackMock=C;exports.createMediaStreamMock=U;exports.createVideoMediaStreamTrackMock=T;exports.doMock=Xe;exports.getAudioContextMediaStreamMock=Je;exports.getAvailableDevices=v;exports.getAvailableDevicesWithResolutions=qe;exports.getCanvasMediaStreamMock=ze;exports.parseMediaStream=F;exports.parseMediaStreamWithoutId=Qe;exports.parseObject=O;exports.parseTracks=j;exports.resetCapabilities=oe;exports.resolutionsList=f;exports.resolveParseArray=Y;exports.setCapabilities=se;exports.setMaxHeightCapabilities=ce;exports.setMaxWidthCapabilities=ae;exports.setMinHeightCapabilities=ne;exports.setMinWidthCapabilities=re;
